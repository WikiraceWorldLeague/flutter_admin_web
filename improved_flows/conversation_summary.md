# Supabase 테이블 구조 개선 대화 기록

## 📅 대화 일시
- 시작: GitHub에서 다른 PC 작업 코드베이스를 fetch/pull 후 진행
- 목적: Supabase 테이블 정리 및 구조 개선

## 🗑️ 1단계: 불필요한 테이블 삭제 (완료)

### 삭제된 테이블들:
1. `clinic_specialties` ✅
2. `specialties` ✅
3. `languages` ✅
4. `guide_languages` ✅
5. `guide_specialties` ✅
6. `settlement_items` ✅

**총 6개 테이블 삭제 완료**

## 🔧 2단계: clinics 테이블 수정 (완료)

### 삭제된 컬럼:
- `address`
- `region`
- `phone`
- `note`

### 추가된 컬럼:
- `commission_rate` (NUMERIC(5,2), 기본값 4.5%, NOT NULL)
- `specialty` (VARCHAR(255))

## 🤔 3단계: 고객 관리 시스템 설계 논의

### 현재 Google 스프레드시트 구조 분석:
- **연번**: 수동 기입
- **예약 번호**: G(그룹사이즈)-YYYYMMDD+(알파벳)
- **고객ID**: 여권이름(대문자1+소문자)-국적코드-생년월일(YYMMDD)
- **구매고유코드**: 고객ID-병원방문일고유값(YYYYMMDD-19000101)

### 주요 필드들:
- 예약고객이름, 이용고객이름, 예약자여부, 국적, 성별, 생년월일
- 병원예약일, 병원방문일, 통역서비스 시간
- 유입경로, 소통채널, 채널계정명
- 병원분류, 시술정보 (대분류, 중분류, 단일시술명, 용량, 부위, 효과)
- 금액정보 (부가세포함가, 커미션요율, 커미션금액, 순매출)

## 💡 4단계: 핵심 인사이트 및 설계 결정

### 고객 중복 관리 문제:
- **문제**: 관리자가 수동 기입으로 기존 고객을 신규로 중복 생성 위험
- **해결방안**: 고객 검색 기능 + 복합 유니크 제약조건

### 예약-고객 관계 이해:
- **1개 예약 = 여러 고객 (그룹 예약이 일반적)**
- **각 고객마다 다른 시술을 받음**
- **올바른 구조**: `reservation → customers → treatments`

### 금액 흐름 정리:
```
1. 총 결제 (고객 → 병원)
2. 병원 수수료 (병원 → 회사) = 회사 매출
3. 가이드 정산 (회사 → 가이드) = 회사 지출  
4. 회사 순매출 = 회사 매출 - 회사 지출
```

## 📦 5단계: 패키지 관리 시스템 설계 (중요 추가)

### 패키지 상품 문제점:
- **분리 가능 패키지**: "울쎄라600샷+써마지600샷" → 각각 분리 가능
- **분리 불가 패키지**: "포텐자+쥬베룩스킨2cc" → 함께 시행하는 콤보
- **통계 분석 필요**: 개별 시술 인기도 및 트렌드 파악

### 해결 방안: 하이브리드 시스템
1. **실제 구매 기록**: 원본 패키지명 그대로 보존
2. **분석용 분해**: 패키지를 구성 시술로 자동 분해
3. **가중치 적용**: 각 구성 시술의 비중 설정

### 시술명 표준화 규칙:
```
[기기명/시술방식] + [용량/샷수] + [부위] (+ [추가옵션])

예시:
✅ "울쎄라300샷_전면부"
✅ "써마지600샷_풀페이스" 
✅ "포텐자_뺨+턱선_다이아몬드팁"
✅ "쥬베룩스킨2cc_전면부"

패키지:
✅ "울쎄라300+써마지300_풀페이스"
✅ "포텐자+쥬베룩스킨2cc_안티에이징패키지"
```

## 📊 6단계: 최종 제안된 테이블 구조

### 기존 테이블 수정:
1. **customers 테이블**: 고객 정보 + 금액 필드 추가
2. **reservations 테이블**: 예약 정보 개선
3. **clinics 테이블**: 이미 수정 완료

### 신규 마스터 테이블:
1. **treatment_categories**: 시술 대분류
2. **treatment_subcategories**: 시술 중분류  
3. **treatment_procedures**: 단일 시술명
4. **treatment_effects**: 시술 효과
5. **customer_treatments**: 고객별 시술 정보

### **🆕 패키지 관리 테이블 (신규 추가)**:
6. **treatment_packages**: 패키지 정의
7. **package_components**: 패키지 구성 요소
8. **treatment_analytics**: 분석용 분해 테이블

### 분석용 테이블:
9. **settlements**: 가이드 정산 정보

## 🔄 7단계: 기존 코드베이스 확장 계획

### 추가할 폴더 구조:
```
lib/features/
├── customers/           # 새로 추가
├── treatments/          # 새로 추가 (패키지 관리 포함)
└── reservations/        # 기존 - 고객 검색 기능 추가
```

### 변경 범위:
- **최소한의 리팩토링**: 기존 예약 플로우에 고객 검색 위젯만 추가
- **확장성**: Clean Architecture 구조로 기능 추가 용이
- **패키지 관리**: 관리자 UI에서 패키지 등록 및 관리

## 🤖 8단계: 패키지 자동 분해 시스템

### 자동화 프로세스:
1. **관리자가 패키지 정의** (프론트엔드 UI)
2. **고객 시술 입력 시 자동 감지**
3. **패키지면 자동 분해** → 분석 테이블 삽입
4. **통계 분석** 시 분해된 데이터 활용

### 구현 방식:
- **PostgreSQL 트리거**: 자동 분해 로직
- **가중치 시스템**: 구성 시술별 비중 설정
- **완전 자동화**: 사용자 개입 최소화

## 🎯 다음 단계 TODO:

1. **SQL 실행**: 제안된 테이블 구조 생성 (03-07 + 패키지 테이블)
2. **프론트엔드 개발**: 
   - 고객 검색/선택 UI
   - 시술 정보 입력 UI (가변 개수)
   - **패키지 관리 UI (신규)**
   - 금액 계산 및 시각화
3. **데이터 마이그레이션**: Google 스프레드시트 → Supabase

## 💰 금액 계산 로직:

```sql
-- 고객별 총 결제금액
총 결제금액 = SUM(각 시술 금액)

-- 회사 매출
회사 매출(부가세 포함) = 총 결제금액 × 병원 commission_rate
회사 매출(부가세 불포함) = 회사 매출(부가세 포함) ÷ 1.1

-- 가이드 정산 (회사 지출)
가이드 정산 금액 = 총 결제금액 × 4.5%

-- 회사 순매출
회사 순매출 = 회사 매출 - 가이드 정산
```

## 📦 패키지 운영 계획:

### Phase 1: 초기 구축
- 테이블 구조 생성
- 주요 패키지 10-20개 수동 등록
- 자동 분해 시스템 테스트

### Phase 2: 본격 운영
- 프론트엔드 패키지 관리 UI 구축
- 실제 고객 데이터로 검증
- 통계 분석 활용

### Phase 3: 고도화
- AI 기반 패키지 자동 분류
- 패턴 학습 및 추천 시스템

---

## 📝 메모
- 새로운 PC에서 작업 재개
- SQL 파일들을 Supabase SQL Editor에서 순서대로 실행
- 패키지 관리 시스템을 포함한 완전한 구조로 확장
- GitHub commit/push 후 지속적 개발 예정 