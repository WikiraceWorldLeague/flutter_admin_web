# Supabase 테이블 구조 개선 대화 기록

## 📅 대화 일시
- 시작: GitHub에서 다른 PC 작업 코드베이스를 fetch/pull 후 진행
- 목적: Supabase 테이블 정리 및 구조 개선

## 🗑️ 1단계: 불필요한 테이블 삭제 (완료)

### 삭제된 테이블들:
1. `clinic_specialties` ✅
2. `specialties` ✅
3. `languages` ✅
4. `guide_languages` ✅
5. `guide_specialties` ✅
6. `settlement_items` ✅

**총 6개 테이블 삭제 완료**

## 🔧 2단계: clinics 테이블 수정 (완료)

### 삭제된 컬럼:
- `address`
- `region`
- `phone`
- `note`

### 추가된 컬럼:
- `commission_rate` (NUMERIC(5,2), 기본값 4.5%, NOT NULL)
- `specialty` (VARCHAR(255))

## 🤔 3단계: 고객 관리 시스템 설계 논의

### 현재 Google 스프레드시트 구조 분석:
- **연번**: 수동 기입
- **예약 번호**: G(그룹사이즈)-YYYYMMDD+(알파벳)
- **고객ID**: 여권이름(대문자1+소문자)-국적코드-생년월일(YYMMDD)
- **구매고유코드**: 고객ID-병원방문일고유값(YYYYMMDD-19000101)

### 주요 필드들:
- 예약고객이름, 이용고객이름, 예약자여부, 국적, 성별, 생년월일
- 병원예약일, 병원방문일, 통역서비스 시간
- 유입경로, 소통채널, 채널계정명
- 병원분류, 시술정보 (대분류, 중분류, 단일시술명, 용량, 부위, 효과)
- 금액정보 (부가세포함가, 커미션요율, 커미션금액, 순매출)

## 💡 4단계: 핵심 인사이트 및 설계 결정

### 고객 중복 관리 문제:
- **문제**: 관리자가 수동 기입으로 기존 고객을 신규로 중복 생성 위험
- **해결방안**: 고객 검색 기능 + 복합 유니크 제약조건

### 예약-고객 관계 이해:
- **1개 예약 = 여러 고객 (그룹 예약이 일반적)**
- **각 고객마다 다른 시술을 받음**
- **올바른 구조**: `reservation → customers → treatments`

### 금액 흐름 정리:
```
1. 총 결제 (고객 → 병원)
2. 병원 수수료 (병원 → 회사) = 회사 매출
3. 가이드 정산 (회사 → 가이드) = 회사 지출  
4. 회사 순매출 = 회사 매출 - 회사 지출
```

## 📊 5단계: 최종 제안된 테이블 구조

### 기존 테이블 수정:
1. **customers 테이블**: 고객 정보 + 금액 필드 추가
2. **reservations 테이블**: 예약 정보 개선
3. **clinics 테이블**: 이미 수정 완료

### 신규 테이블 생성:
1. **treatment_categories**: 시술 대분류
2. **treatment_subcategories**: 시술 중분류  
3. **treatment_procedures**: 단일 시술명
4. **treatment_effects**: 시술 효과
5. **customer_treatments**: 고객별 시술 정보
6. **settlements**: 가이드 정산 정보

## 🔄 6단계: 기존 코드베이스 확장 계획

### 추가할 폴더 구조:
```
lib/features/
├── customers/           # 새로 추가
├── treatments/          # 새로 추가 
└── reservations/        # 기존 - 고객 검색 기능 추가
```

### 변경 범위:
- **최소한의 리팩토링**: 기존 예약 플로우에 고객 검색 위젯만 추가
- **확장성**: Clean Architecture 구조로 기능 추가 용이

## 🎯 다음 단계 TODO:

1. **SQL 실행**: 제안된 테이블 구조 생성
2. **프론트엔드 개발**: 
   - 고객 검색/선택 UI
   - 시술 정보 입력 UI (가변 개수)
   - 금액 계산 및 시각화
3. **데이터 마이그레이션**: Google 스프레드시트 → Supabase

## 💰 금액 계산 로직:

```sql
-- 고객별 총 결제금액
총 결제금액 = SUM(각 시술 금액)

-- 회사 매출
회사 매출(부가세 포함) = 총 결제금액 × 병원 commission_rate
회사 매출(부가세 불포함) = 회사 매출(부가세 포함) ÷ 1.1

-- 가이드 정산 (회사 지출)
가이드 정산 금액 = 총 결제금액 × 4.5%

-- 회사 순매출
회사 순매출 = 회사 매출 - 가이드 정산
```

---

## 📝 메모
- 내일 사무실 laptop PC에서 작업 이어서 진행
- SQL 파일들을 Supabase SQL Editor에서 순서대로 실행
- GitHub commit/push 후 사무실에서 pull 예정 