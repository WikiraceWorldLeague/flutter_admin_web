✅ 정산 관리 기능 요구사항
1. 정산 관리 기능 범위
정산 대상
→ 맞습니다. 정산은 가이드별로 "예약 완료(completed)" 상태인 건에 한해 수수료를 기준으로 진행됩니다.

정산 주기
→ 수동 정산 방식을 우선 도입합니다. 향후 데이터가 누적되면 월별 집계 방식도 고려할 수 있습니다.

정산 항목

가이드 수수료율
→ 가이드마다 개별 수수료율 설정이 가능합니다. 기본값은 30%이지만, 향후 상황에 따라 다르게 설정될 수 있습니다.

정산 기준 금액
→ 예약 시 고객이 실제 병원에 결제한 총액(예약 데이터 내 필드로 포함 예정)을 기준으로 합니다.

공제 항목
→ 현재는 별도 공제 항목 없이 단순 정산 구조로 시작합니다. 향후 불이행 시 패널티나 공제 항목은 추후 적용.

2. 정산 상태 관리
정산 상태 워크플로우
→ 다음과 같은 3단계 상태로 구성합니다:

pending (정산 대상이나 미처리)

approved (관리자가 정산 승인)

paid (실제로 지급 완료)

승인 권한
→ 관리자만 승인 및 지급 처리 가능합니다. 일반 가이드는 정산 요청을 별도로 하지 않으며, 완료 예약을 기준으로 관리자가 정산 내역을 승인합니다.

3. UI/UX 요구사항
정산 목록 UI
→ 가이드별 및 기간별 필터링 기능 제공 (예: 가이드명, 월별 정산, 상태별 필터)

정산 상세 UI
→ 각 정산 항목(예약 건)에 대해 아래 정보가 표시되어야 합니다:

예약일자

병원명

고객명

고객 결제금액

가이드 수수료율

지급 예정 금액

정산 상태

일괄 처리 기능
→ 여러 건을 선택하여 한 번에 승인 또는 지급 상태로 변경할 수 있는 기능 필요합니다. (체크박스 선택 → 상태 변경)

📝 추가 사항 (향후 고려)
CSV 다운로드: 정산 내역을 월별로 엑셀/CSV로 추출하는 기능은 추후 구현 예정입니다.

알림 연동: 정산 상태 변경 시 가이드에게 알림 연동은 Phase 3 이후로 미룰 수 있습니다.

✅ 데이터베이스 스키마 관련 질문 답변
1. 예약 테이블의 고객 결제금액 필드
현재 없다면 새로 추가해야 합니다.

필드명 제안: payment_amount
→ 타입: numeric 또는 decimal(10,2)
→ 설명: 고객이 병원에 실제 결제한 금액을 수동 입력 (또는 추후 API 연동 가능)

✅ 이 필드는 정산 계산의 기준이 되므로 필수입니다.

2. 가이드별 수수료율
guides 테이블에 새 컬럼 추가 필요

컬럼명 제안: commission_rate
→ 타입: numeric(5,2)
→ 기본값: 30.00 (30%)
→ 설명: 가이드 개별 수수료율. 미설정 시 기본값 사용 가능

✅ 수수료율이 정산마다 달라질 수 있기 때문에, reservation 기준의 수수료도 저장하는 것이 좋습니다 (다음 항목 참고).

3. 정산 테이블 (settlements) 구조
제안한 구조는 적절하며 추천드립니다. 약간의 보완 제안도 포함해 정리드리면 아래와 같습니다:

sql

settlements (
  id SERIAL PRIMARY KEY,
  guide_id UUID REFERENCES guides(id),
  reservation_id UUID REFERENCES reservations(id),
  payment_amount NUMERIC(10,2),        -- 고객 결제 금액
  commission_rate NUMERIC(5,2),        -- 해당 정산에 사용된 수수료율 (%)
  settlement_amount NUMERIC(10,2),     -- 실제 지급 금액
  status TEXT CHECK (status IN ('pending', 'approved', 'paid')) DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT now(),
  approved_at TIMESTAMP,
  paid_at TIMESTAMP
)
🔹 추가 제안:

notes TEXT 컬럼도 하나 넣어두면 수기 메모나 예외 케이스 기록에 유용합니다.

4. 정산 생성 시점
추천: 예약이 completed 상태가 될 때 자동 생성

이유:

수동 생성은 누락이나 실수가 많고, 관리 비용이 증가합니다.

자동 생성 후 승인 상태로 두면, 관리자는 승인 여부만 판단하면 됩니다.

워크플로우 제안:

예약이 completed 상태로 바뀌는 순간 settlements 자동 생성 (status = pending)

관리자는 approved 버튼으로 승인

지급이 완료되면 paid 상태로 업데이트

✅ 단, 자동 생성을 위해서는 reservation에 다음 2가지 정보가 있어야 합니다:

payment_amount

guide_id

둘 중 하나라도 없다면 자동 생성을 보류하고 로그만 남기도록 처리해도 좋습니다.